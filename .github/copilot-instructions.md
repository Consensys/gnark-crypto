---
applyTo: "**"
---
# gnark-crypto AI Agent Instructions

## Architecture Overview
This is a **heavily code-generated** cryptography library. ~90% of code under `ecc/` and `field/` is generated from Go templates.

**Key directories:**
- `internal/generator/` - Main template engine (entry: `main.go`, run via `go generate ./...`)
- `ecc/<curve>/` - Generated curve implementations (bn254, bls12-381, bls12-377, etc.)
- `field/asm/` - Shared assembly code for field arithmetic (amd64/arm64)

## Critical: Generated vs Non-Generated Files
**Before editing any file**, check if it starts with `// Code generated by consensys/gnark-crypto DO NOT EDIT`.

- **Generated files** → Edit the `.tmpl` template in `internal/generator/` instead
- **Non-generated files** → Edit directly (see [non_generated_files.txt](non_generated_files.txt) for reference)

Template locations follow a pattern: `ecc/bn254/g1.go` → `internal/generator/ecc/template/point.go.tmpl`

## Workflow for Changes

1. **Identify if generated**: Check file header for "DO NOT EDIT"
2. **Edit template**: Modify `.tmpl` file in `internal/generator/<component>/template/`
3. **Regenerate**: Run `go generate ./...` from repo root (takes ~1-2 min)
4. **Test affected curves**: Run `go test -short ./ecc/bn254/...` (or specific curve)
5. **Full test**: Run `go test -short ./...` before committing

## Testing Patterns
- Tests use [gopter](https://github.com/leanovate/gopter) for property-based testing
- Use `go test -short` to skip slow tests (recommended during development)
- Test templates are in `internal/generator/<component>/template/tests/`
- Benchmarks: `go test -short -benchmem -count=4 -bench=<BenchmarkName> ./ecc/bn254/...`

## Code Style & Performance
- Follow [Google Go Style Guide](https://google.github.io/styleguide/go/)
- **Performance is critical**: Avoid allocations in hot paths, use pointer receivers
- Field elements use Montgomery representation (see `Element` type in `fr/` or `fp/`)
- Assembly is used for critical field operations - check `element_amd64.go` / `element_arm64.go` for Go declarations

## Common Patterns
```go
// Field elements are fixed-size arrays, not slices
type Element [4]uint64  // bn254/fr - 4 limbs for 254-bit field

// Jacobian coordinates for efficient EC operations
type G1Jac struct { X, Y, Z fp.Element }

// Affine for storage/serialization
type G1Affine struct { X, Y fp.Element }
```
