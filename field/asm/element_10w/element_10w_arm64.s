// Code generated by gnark-crypto/generator. DO NOT EDIT.
#include "textflag.h"
#include "funcdata.h"
#include "go_asm.h"

// mul(res, x, y *Element)
// Algorithm 2 of Faster Montgomery Multiplication and Multi-Scalar-Multiplication for SNARKS
// by Y. El Housni and G. Botrel https://doi.org/10.46586/tches.v2023.i3.504-521
TEXT ·mul(SB), NOFRAME|NOSPLIT, $0-24
#define DIVSHIFT() \
	MOVD  $const_qInvNeg, R0   \
	MUL   R12, R0, R1          \
	MOVD  ·qElement+0(SB), R0  \
	MUL   R0, R1, R0           \
	ADDS  R0, R12, R12         \
	MOVD  ·qElement+8(SB), R0  \
	MUL   R0, R1, R0           \
	ADCS  R0, R13, R13         \
	MOVD  ·qElement+16(SB), R0 \
	MUL   R0, R1, R0           \
	ADCS  R0, R14, R14         \
	MOVD  ·qElement+24(SB), R0 \
	MUL   R0, R1, R0           \
	ADCS  R0, R15, R15         \
	MOVD  ·qElement+32(SB), R0 \
	MUL   R0, R1, R0           \
	ADCS  R0, R16, R16         \
	MOVD  ·qElement+40(SB), R0 \
	MUL   R0, R1, R0           \
	ADCS  R0, R17, R17         \
	MOVD  ·qElement+48(SB), R0 \
	MUL   R0, R1, R0           \
	ADCS  R0, R19, R19         \
	MOVD  ·qElement+56(SB), R0 \
	MUL   R0, R1, R0           \
	ADCS  R0, R20, R20         \
	MOVD  ·qElement+64(SB), R0 \
	MUL   R0, R1, R0           \
	ADCS  R0, R21, R21         \
	MOVD  ·qElement+72(SB), R0 \
	MUL   R0, R1, R0           \
	ADCS  R0, R22, R22         \
	ADC   R23, ZR, R23         \
	MOVD  ·qElement+0(SB), R0  \
	UMULH R0, R1, R0           \
	ADDS  R0, R13, R12         \
	MOVD  ·qElement+8(SB), R0  \
	UMULH R0, R1, R0           \
	ADCS  R0, R14, R13         \
	MOVD  ·qElement+16(SB), R0 \
	UMULH R0, R1, R0           \
	ADCS  R0, R15, R14         \
	MOVD  ·qElement+24(SB), R0 \
	UMULH R0, R1, R0           \
	ADCS  R0, R16, R15         \
	MOVD  ·qElement+32(SB), R0 \
	UMULH R0, R1, R0           \
	ADCS  R0, R17, R16         \
	MOVD  ·qElement+40(SB), R0 \
	UMULH R0, R1, R0           \
	ADCS  R0, R19, R17         \
	MOVD  ·qElement+48(SB), R0 \
	UMULH R0, R1, R0           \
	ADCS  R0, R20, R19         \
	MOVD  ·qElement+56(SB), R0 \
	UMULH R0, R1, R0           \
	ADCS  R0, R21, R20         \
	MOVD  ·qElement+64(SB), R0 \
	UMULH R0, R1, R0           \
	ADCS  R0, R22, R21         \
	MOVD  ·qElement+72(SB), R0 \
	UMULH R0, R1, R0           \
	ADCS  R0, R23, R22         \

#define MUL_WORD_N() \
	MUL   R2, R1, R0   \
	ADDS  R0, R12, R12 \
	MUL   R3, R1, R0   \
	ADCS  R0, R13, R13 \
	MUL   R4, R1, R0   \
	ADCS  R0, R14, R14 \
	MUL   R5, R1, R0   \
	ADCS  R0, R15, R15 \
	MUL   R6, R1, R0   \
	ADCS  R0, R16, R16 \
	MUL   R7, R1, R0   \
	ADCS  R0, R17, R17 \
	MUL   R8, R1, R0   \
	ADCS  R0, R19, R19 \
	MUL   R9, R1, R0   \
	ADCS  R0, R20, R20 \
	MUL   R10, R1, R0  \
	ADCS  R0, R21, R21 \
	MUL   R11, R1, R0  \
	ADCS  R0, R22, R22 \
	ADC   ZR, ZR, R23  \
	UMULH R2, R1, R0   \
	ADDS  R0, R13, R13 \
	UMULH R3, R1, R0   \
	ADCS  R0, R14, R14 \
	UMULH R4, R1, R0   \
	ADCS  R0, R15, R15 \
	UMULH R5, R1, R0   \
	ADCS  R0, R16, R16 \
	UMULH R6, R1, R0   \
	ADCS  R0, R17, R17 \
	UMULH R7, R1, R0   \
	ADCS  R0, R19, R19 \
	UMULH R8, R1, R0   \
	ADCS  R0, R20, R20 \
	UMULH R9, R1, R0   \
	ADCS  R0, R21, R21 \
	UMULH R10, R1, R0  \
	ADCS  R0, R22, R22 \
	UMULH R11, R1, R0  \
	ADC   R0, R23, R23 \
	DIVSHIFT()         \

#define MUL_WORD_0() \
	MUL   R2, R1, R12  \
	MUL   R3, R1, R13  \
	MUL   R4, R1, R14  \
	MUL   R5, R1, R15  \
	MUL   R6, R1, R16  \
	MUL   R7, R1, R17  \
	MUL   R8, R1, R19  \
	MUL   R9, R1, R20  \
	MUL   R10, R1, R21 \
	MUL   R11, R1, R22 \
	UMULH R2, R1, R0   \
	ADDS  R0, R13, R13 \
	UMULH R3, R1, R0   \
	ADCS  R0, R14, R14 \
	UMULH R4, R1, R0   \
	ADCS  R0, R15, R15 \
	UMULH R5, R1, R0   \
	ADCS  R0, R16, R16 \
	UMULH R6, R1, R0   \
	ADCS  R0, R17, R17 \
	UMULH R7, R1, R0   \
	ADCS  R0, R19, R19 \
	UMULH R8, R1, R0   \
	ADCS  R0, R20, R20 \
	UMULH R9, R1, R0   \
	ADCS  R0, R21, R21 \
	UMULH R10, R1, R0  \
	ADCS  R0, R22, R22 \
	UMULH R11, R1, R0  \
	ADC   R0, ZR, R23  \
	DIVSHIFT()         \

	MOVD y+16(FP), R1
	MOVD x+8(FP), R0
	LDP  0(R0), (R2, R3)
	LDP  16(R0), (R4, R5)
	LDP  32(R0), (R6, R7)
	LDP  48(R0), (R8, R9)
	LDP  64(R0), (R10, R11)
	MOVD y+16(FP), R1
	MOVD 0(R1), R1
	MUL_WORD_0()
	MOVD y+16(FP), R1
	MOVD 8(R1), R1
	MUL_WORD_N()
	MOVD y+16(FP), R1
	MOVD 16(R1), R1
	MUL_WORD_N()
	MOVD y+16(FP), R1
	MOVD 24(R1), R1
	MUL_WORD_N()
	MOVD y+16(FP), R1
	MOVD 32(R1), R1
	MUL_WORD_N()
	MOVD y+16(FP), R1
	MOVD 40(R1), R1
	MUL_WORD_N()
	MOVD y+16(FP), R1
	MOVD 48(R1), R1
	MUL_WORD_N()
	MOVD y+16(FP), R1
	MOVD 56(R1), R1
	MUL_WORD_N()
	MOVD y+16(FP), R1
	MOVD 64(R1), R1
	MUL_WORD_N()
	MOVD y+16(FP), R1
	MOVD 72(R1), R1
	MUL_WORD_N()
	LDP  ·qElement+0(SB), (R2, R3)
	LDP  ·qElement+16(SB), (R4, R5)
	LDP  ·qElement+32(SB), (R6, R7)
	LDP  ·qElement+48(SB), (R8, R9)
	LDP  ·qElement+64(SB), (R10, R11)

	// reduce if necessary
	SUBS R2, R12, R2
	SBCS R3, R13, R3
	SBCS R4, R14, R4
	SBCS R5, R15, R5
	SBCS R6, R16, R6
	SBCS R7, R17, R7
	SBCS R8, R19, R8
	SBCS R9, R20, R9
	SBCS R10, R21, R10
	SBCS R11, R22, R11
	MOVD res+0(FP), R0
	CSEL CS, R2, R12, R12
	CSEL CS, R3, R13, R13
	STP  (R12, R13), 0(R0)
	CSEL CS, R4, R14, R14
	CSEL CS, R5, R15, R15
	STP  (R14, R15), 16(R0)
	CSEL CS, R6, R16, R16
	CSEL CS, R7, R17, R17
	STP  (R16, R17), 32(R0)
	CSEL CS, R8, R19, R19
	CSEL CS, R9, R20, R20
	STP  (R19, R20), 48(R0)
	CSEL CS, R10, R21, R21
	CSEL CS, R11, R22, R22
	STP  (R21, R22), 64(R0)
	RET

// reduce(res *Element)
TEXT ·reduce(SB), NOFRAME|NOSPLIT, $0-8
	LDP  ·qElement+0(SB), (R10, R11)
	LDP  ·qElement+16(SB), (R12, R13)
	LDP  ·qElement+32(SB), (R14, R15)
	LDP  ·qElement+48(SB), (R16, R17)
	LDP  ·qElement+64(SB), (R19, R20)
	MOVD res+0(FP), R21
	LDP  0(R21), (R0, R1)
	LDP  16(R21), (R2, R3)
	LDP  32(R21), (R4, R5)
	LDP  48(R21), (R6, R7)
	LDP  64(R21), (R8, R9)

	// q = t - q
	SUBS R10, R0, R10
	SBCS R11, R1, R11
	SBCS R12, R2, R12
	SBCS R13, R3, R13
	SBCS R14, R4, R14
	SBCS R15, R5, R15
	SBCS R16, R6, R16
	SBCS R17, R7, R17
	SBCS R19, R8, R19
	SBCS R20, R9, R20

	// if no borrow, return q, else return t
	CSEL CS, R10, R0, R0
	CSEL CS, R11, R1, R1
	STP  (R0, R1), 0(R21)
	CSEL CS, R12, R2, R2
	CSEL CS, R13, R3, R3
	STP  (R2, R3), 16(R21)
	CSEL CS, R14, R4, R4
	CSEL CS, R15, R5, R5
	STP  (R4, R5), 32(R21)
	CSEL CS, R16, R6, R6
	CSEL CS, R17, R7, R7
	STP  (R6, R7), 48(R21)
	CSEL CS, R19, R8, R8
	CSEL CS, R20, R9, R9
	STP  (R8, R9), 64(R21)
	RET
